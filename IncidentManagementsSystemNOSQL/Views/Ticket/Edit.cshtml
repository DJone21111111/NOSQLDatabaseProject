@model IncidentManagementsSystemNOSQL.Models.Ticket

@{
    ViewData["Title"] = "Edit Ticket";
}

<style>
    .edit-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem;
        border-radius: 10px;
        margin-bottom: 2rem;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    .form-card {
        border: none;
        border-radius: 15px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.07);
    }
    
    .form-section {
        background: #f8f9fa;
        padding: 1.5rem;
        border-radius: 10px;
        margin-bottom: 1.5rem;
    }
    
    .form-section h5 {
        margin-bottom: 1.25rem;
        color: #495057;
        font-weight: 600;
    }
    
    .status-badge {
        display: inline-block;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-size: 0.875rem;
        font-weight: 500;
        margin-bottom: 0.5rem;
    }
    
    .btn-action {
        padding: 0.75rem 2rem;
        border-radius: 25px;
        font-weight: 600;
        font-size: 0.95rem;
    }
</style>

<div class="container-fluid px-4 py-3">
    <!-- Header -->
    <div class="edit-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="mb-2">‚úèÔ∏è Edit Ticket</h1>
                <p class="mb-0 opacity-75">Update ticket information and manage status</p>
            </div>
            <div>
                <span class="status-badge bg-white text-dark">
                    <strong>ID:</strong> @Model.TicketId
                </span>
            </div>
        </div>
    </div>

    <form asp-action="Edit" asp-route-id="@Model.Id" method="post" class="needs-validation" novalidate>
        @Html.AntiForgeryToken()
        <input type="hidden" asp-for="Id" />
        <input type="hidden" asp-for="TicketId" />
        <input type="hidden" asp-for="DateCreated" />
        <input type="hidden" asp-for="DateClosed" />
        
        <!-- Hidden fields for Employee (nested object) -->
        <input type="hidden" asp-for="Employee.EmployeeId" />
        <input type="hidden" asp-for="Employee.Name" />
        <input type="hidden" asp-for="Employee.Email" />
        <input type="hidden" asp-for="Employee.Role" />
        <input type="hidden" asp-for="Employee.Department.DepartmentId" />
        <input type="hidden" asp-for="Employee.Department.Name" />
        <input type="hidden" asp-for="Employee.Department.Description" />
        
        <!-- Hidden fields for AssignedTo if exists -->
        @if (Model.AssignedTo != null)
        {
            <input type="hidden" asp-for="AssignedTo.EmployeeId" />
            <input type="hidden" asp-for="AssignedTo.Name" />
            <input type="hidden" asp-for="AssignedTo.Role" />
            <input type="hidden" asp-for="AssignedTo.Email" />
        }
        
        <!-- Hidden fields for Comments -->
        @for (int i = 0; i < Model.Comments.Count; i++)
        {
            <input type="hidden" asp-for="Comments[i].CommentId" />
            <input type="hidden" asp-for="Comments[i].Text" />
            <input type="hidden" asp-for="Comments[i].CreatedAt" />
            <input type="hidden" asp-for="Comments[i].Author.EmployeeId" />
            <input type="hidden" asp-for="Comments[i].Author.Name" />
            <input type="hidden" asp-for="Comments[i].Author.Email" />
            <input type="hidden" asp-for="Comments[i].Author.Role" />
        }
        
        <div class="row">
            <!-- Main Ticket Information -->
            <div class="col-lg-8">
                <div class="card form-card mb-4">
                    <div class="card-body p-4">
                        <div class="form-section">
                            <h5>üìã Ticket Details</h5>
                            
                            <div class="mb-3">
                                <label asp-for="Title" class="form-label fw-bold">Title *</label>
                                <input asp-for="Title" class="form-control form-control-lg" placeholder="Enter ticket title" required />
                                <span asp-validation-for="Title" class="text-danger"></span>
                            </div>

                            <div class="mb-3">
                                <label asp-for="Description" class="form-label fw-bold">Description</label>
                                <textarea asp-for="Description" class="form-control" rows="5" placeholder="Detailed description of the issue..."></textarea>
                                <span asp-validation-for="Description" class="text-danger"></span>
                            </div>
                        </div>

                        <div class="form-section">
                            <h5>üë§ Reporter Information</h5>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-bold">Employee Name</label>
                                    <input type="text" class="form-control" value="@Model.Employee.Name" readonly />
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-bold">Employee Email</label>
                                    <input type="text" class="form-control" value="@Model.Employee.Email" readonly />
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-bold">Department</label>
                                    <input type="text" class="form-control" value="@Model.Employee.Department.Name" readonly />
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-bold">Employee ID</label>
                                    <input type="text" class="form-control" value="@Model.Employee.EmployeeId" readonly />
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Status and Assignment Sidebar -->
            <div class="col-lg-4">
                <div class="card form-card mb-4">
                    <div class="card-body p-4">
                        <div class="form-section">
                            <h5>üìä Status Management</h5>
                            
                            <div class="mb-3">
                                <label asp-for="Status" class="form-label fw-bold">Current Status *</label>
                                <select asp-for="Status" class="form-select form-select-lg" required>
                                    <option value="">-- Select Status --</option>
                                    <option value="open">üü¢ Open</option>
                                    <option value="in_progress">‚öôÔ∏è In Progress</option>
                                    <option value="closed_resolved">‚úÖ Closed - Resolved</option>
                                    <option value="closed_no_resolve">‚ùå Closed - No Resolve</option>
                                </select>
                                <span asp-validation-for="Status" class="text-danger"></span>
                                <small class="form-text text-muted mt-2 d-block">
                                    Change status to "Closed" instead of deleting tickets
                                </small>
                            </div>

                            <div class="mb-3">
                                <label class="form-label fw-bold">Date Created</label>
                                <input type="text" class="form-control" value="@Model.DateCreated.ToLocalTime().ToString("MMM dd, yyyy HH:mm")" readonly />
                            </div>

                            @if (Model.DateClosed.HasValue)
                            {
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Date Closed</label>
                                    <input type="text" class="form-control" value="@Model.DateClosed.Value.ToLocalTime().ToString("MMM dd, yyyy HH:mm")" readonly />
                                </div>
                            }
                        </div>

                        <div class="form-section">
                            <h5>üë• Assignment</h5>
                            
                            <div class="mb-3">
                                <label class="form-label fw-bold">Assigned To</label>
                                @if (Model.AssignedTo != null)
                                {
                                    <div class="alert alert-info mb-2">
                                        <strong>@Model.AssignedTo.Name</strong><br />
                                        <small>@Model.AssignedTo.EmployeeId</small>
                                    </div>
                                }
                                else
                                {
                                    <div class="alert alert-warning mb-2">
                                        <small>‚ö†Ô∏è Not assigned yet</small>
                                    </div>
                                }
                                <small class="form-text text-muted">
                                    Assignment feature coming soon
                                </small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Comments Section -->
                <div class="card form-card">
                    <div class="card-body p-4">
                        <h5 class="mb-3">üí¨ Comments (@Model.Comments.Count)</h5>
                        
                        @if (Model.Comments.Any())
                        {
                            <div class="comments-list" style="max-height: 300px; overflow-y: auto;">
                                @foreach (var comment in Model.Comments.OrderByDescending(c => c.CreatedAt))
                                {
                                    <div class="card mb-2" style="background: #f8f9fa;">
                                        <div class="card-body p-2">
                                            <small class="text-muted d-block mb-1">
                                                <strong>@comment.Author.Name</strong> - 
                                                @comment.CreatedAt.ToLocalTime().ToString("MMM dd, HH:mm")
                                            </small>
                                            <p class="mb-0" style="font-size: 0.875rem;">@comment.Text</p>
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <p class="text-muted mb-0"><small>No comments yet</small></p>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card form-card">
                    <div class="card-body p-4">
                        <div class="d-flex justify-content-between align-items-center">
                            <a asp-action="Index" asp-controller="Dashboard" class="btn btn-outline-secondary btn-action">
                                ‚Üê Back to Dashboard
                            </a>
                            <div>
                                <button type="submit" class="btn btn-primary btn-action me-2">
                                    üíæ Save Changes
                                </button>
                                <a asp-action="Details" asp-route-id="@Model.Id" class="btn btn-outline-info btn-action">
                                    üëÅÔ∏è View Details
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    <script>
        // Bootstrap validation
        (function() {
            'use strict';
            var forms = document.querySelectorAll('.needs-validation');
            Array.prototype.slice.call(forms).forEach(function(form) {
                form.addEventListener('submit', function(event) {
                    if (!form.checkValidity()) {
                        event.preventDefault();
                        event.stopPropagation();
                    }
                    form.classList.add('was-validated');
                }, false);
            });
        })();

        // Status change warning
        document.querySelector('select[name="Status"]').addEventListener('change', function() {
            const status = this.value;
            if (status.includes('closed')) {
                if (!confirm('Are you sure you want to close this ticket? This action will set the closed date.')) {
                    this.value = '@Model.Status';
                }
            }
        });
    </script>
}
